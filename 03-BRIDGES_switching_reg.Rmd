```{r include=FALSE}
knitr::opts_chunk$set(comment = NA, message = FALSE, results = 'hide', warning= FALSE, echo = FALSE, include= TRUE, fig.height = 4, fig.width = 6, cache = FALSE)
library(tidyverse)
library(broom)
library(broom.mixed)
library(ramify)
library(MASS)
library(kableExtra)
library(lme4)
library(compiler)
require(parallel)
require(boot)
library(mice)
library(miceadds)
library(selectiveInference)
library(mitml)
```




# Imputation and inference on Switching frequency

```{r echo = FALSE,results= TRUE, include = TRUE}
imputed <-readRDS("/home/christian/Research/Brain_stuff/BRIDGES_GIG_ICA/GIG-ICA-5-updated-GIFT/thresh50/Regressions/imputed_switching_data.rds")
age_df <- read.csv("/home/christian/Research/Brain_stuff/BRIDGES_GIG_ICA/switching_data.csv") 


imputed <- mice::filter(imputed, grid %in% age_df$grid)

imp1 <- complete(imputed, action = 1)


mod <- lm(Freq ~ age + BSSI, data=  imputed$data)

X <- data.matrix(imp1[,c(3,4,6,7,8,22)])
y <- data.matrix(imp1[24])




stepped <- fs(X, y)
fsInf(stepped)

test <- fsInf(stepped, k = 2, type= "all")

                   

imp_switch_fit <- with(imputed, lm(Freq ~ age +  BSSI))

switch_age <- with(imputed, lm(Freq ~ age))
switch_all <- with(imputed, lm(Freq ~ age +  BSSI + BDI + log(lifetime_nssie+1)))
switch_BSSI <- with(imputed, lm(Freq ~ age +  BSSI))
switch_BDI <- with(imputed, lm(Freq ~ age + BDI))
switch_Mod_Severe <- with(imputed, lm(Freq ~ Mod_Severe))
switch.NSSI.Group <- with(imputed, lm(Freq ~ Lifetime.NSSI.Group))
testEstimates(as.mitml.result(switch.NSSI.Group), extra.pars = FALSE)
switch_nssi1 <- with(imputed, lm(Freq ~ age + lifetime_nssie))
switch_nssi2 <- with(imputed, lm(Freq ~ age + exp(lifetime_nssie)))
imp_switch_fit <- with(imputed, lm(Freq ~ age +  lifetime_nssie))



D3(switch_BSSI, switch_age)

compute_llike <- function(fit_object, nslopes) {
  # fit_object is what was fit with the 'with' fucntion
  # nslopes is the number of slopes being estimated in the model
  # make predictions for each imputation
  predlist <- lapply(fit_object$analyses, broom::augment, se.fit = TRUE)
  # extract just the fits 
  l <- matrix(nrow = 124, ncol = 50)
  for (i in 1:length(predlist)) {
    l[,i] <- predlist[[i]][[6]]
  }
  pooledy <- apply(l, mean, MARGIN = 1)
  data <- pooledy
  # estimte sigma
  hatvar <- sum((imputed$data$Freq - pooledy)**2)/(124-nslopes)
  
  llikeliy <- -(126/2) * log(2*3.14) - (126/2) * log(hatvar) - (1/2*hatvar) * sum((imputed$data$Freq - pooledy)**2)
  llikeliy
}

all_l <- compute_llike(switch_all, nslopes =4 ) 
allBSSI_l <- compute_llike(switch_BSSI, nslopes =2 ) 
BDI_l <- compute_llike(switch_BDI, nslopes =2 ) 
Mod_l <- compute_llike(switch_Mod_Severe, nslopes =2 ) 
nssi_l1 <- compute_llike(switch_nssi1, nslopes =2 ) 
nssi_l2 <- compute_llike(switch_nssi2, nslopes =2 ) 

```


```{r}

rep <- summary(pool(imp_switch_fit))[2:3, c(1,2,3,6)]
rep$adjusted <- p.adjust(rep$p.value, method = "holm")

rep[,c(1,2,3,5)] %>%
  kable(digits = c(0,5,5),  col.names = c("", "Estimate", "P(*>0)"), row.names = FALSE) %>%
  kable_classic() 
#   save_kable("Switch_model.png")
```
![](/home/christian/Research/Booktry/Switch_model.png){width=4in}

```{r}
inf_mat <- matrix(ncol = 8)

for (i in 1:50) {
  data <- complete(imputed, action = 1) %>%
  mutate(No = grepl("No NSSI", Lifetime.NSSI.Group),
         Mild = grepl("Mild NSSI", Lifetime.NSSI.Group),
         Moderate = grepl("Moderate NSSI", Lifetime.NSSI.Group),
         Severe = grepl("Severe NSSI", Lifetime.NSSI.Group)) %>%
  dplyr::select(-c(Lifetime.NSSI.Group, Mod_Severe))


  X <- data %>% 
    dplyr::select(-c(Freq))
  X = scale(X, TRUE, TRUE) / sqrt(n-1)
  
  Y <- data %>%
    dplyr::select(Freq)
  
  y <- Y$Freq
  
  
  result <- groupfs(X, y, index = c(1,1,1, 2,3,4,5,6,7,7,7,7))
  out.group <- groupfsInf(result)
  
  inf_i <- data.frame(Var = out.group$vars)
}


plot(fs(X, y))
```


### Residual analysis
```{r include = TRUE, fig.show="hold", out.width='49%'}
RS1=NULL
PS1=NULL

for(i in 1:5){
  RS1=rbind(RS1,residuals(imp_switch_fit$analyses[[i]]))
  RS=colMeans(RS1)
  PS1=rbind(PS1,predict(imp_switch_fit$analyses[[i]])) 
  PS=colMeans(PS1)}

# for(i in 1:20) {
#   plot(predict(imp_switch_fit$analyses[[i]]), residuals(imp_switch_fit$analyses[[i]]))
# }



# for(i in 1:20) {
#   qqnorm(resid(imp_switch_fit$analyses[[i]]))
#   qqline(resid(imp_switch_fit$analyses[[i]]))
# }

as.data.frame(cbind(PS, RS)) %>%
  ggplot(aes(x = PS, RS)) +
  geom_point() +
  geom_smooth(method = "loess") +
  ylab("Residual") +
  xlab("Predicted value")

as.data.frame(RS) %>%
  ggplot(aes(sample = RS)) +
  geom_qq() +
  geom_qq_line() +
  ylab("Sample Quantile") +
  xlab("Theoretical Quantiles")

```    
  
Residuals don't show any trends, appear to be normally distributed, therefore valid inferences can be drawn.  


```{r}
df <- read.csv("/home/christian/Research/Brain_stuff/BRIDGES_GIG_ICA/complete bridges y1.csv")
colnames(df)
lm(df$lifetime_number_attempts~ df$)
```



```{r}
df <- imputed$data

df %>% 
  filter(Lifetime.NSSI.Group == "No NSSI") %>%
  summarize(cor(Freq, as.numeric(age)))

df %>% 
  group_by(Lifetime.NSSI.Group) %>%
  summarize(cor(Freq, as.numeric(age)))

```


```{r}
r <- resid(lm(Freq~ age + BSSI, data = age_df))
age_df %>%
  dplyr::select(age, BSSI, Freq)  %>%
  drop_na() %>%
  mutate(Residual = r, age = as.numeric(age), Age= age) %>%
  pivot_longer(c(Age,BSSI), names_to = "Variable", values_to = "Measure") %>%
  ggplot(aes( x= Measure, y = Residual)) +
  geom_point() +
  geom_smooth(span = 1) + 
  facet_wrap(~Variable, scale="free_x")
```


```{r}
#####################################
## New depression variable 
age_df <- read.csv("/home/christian/Research/Brain_stuff/BRIDGES_GIG_ICA/switching_data.csv")
current_depress <- read.csv("/home/christian/Research/Brain_stuff/BRIDGES_GIG_ICA/current_depression.csv")

age_df <- age_df %>% 
  dplyr::select(grid, age, BSSI, Freq) %>%
  mutate(depr = grid %in% current_depress$GRID.number.)

summary(lm(Freq ~ depr, data= age_df))

```

